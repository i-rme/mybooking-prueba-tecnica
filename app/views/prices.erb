<div class="content">
      <div class="container">
        <h1>Prices page (SPA)</h1>
        <p><%= @message %></p>
        <div class="row">
          <form class="row g-3">
            <div class="col-md-2">
              <label for="rental_location" class="form-label">Sucursal</label>
              <select name="rental_location" class="form-select" id="rental_location">
                <option value="">Seleccione sucursal</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="rate_type" class="form-label">Tipo de tarifa</label>
               <select name="rate_type" class="form-select" id="rate_type" disabled>
                <option value="">Seleccione tipo de tarifa</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="season_definition_id" class="form-label">Grupo de temporadas</label>
              <select name="season_definition_id" class="form-select" id="season_definition_id" disabled>
                <option value="">Seleccione grupo de temporadas</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="season_id" class="form-label">Temporada</label>
                <select name="season_id" class="form-select" id="season_id" disabled>
                <option value="">Seleccione temporada</option>
                <option value="0">Sin temporadas</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="season_duration" class="form-label">Duración</label>
              <select name="season_duration" class="form-select" id="season_duration" disabled>
                <option value="">Seleccione duración</option>
              </select>
            </div>
            <div class="col-md-1">
              <button class="btn btn-primary w-100" style="margin-top: 32px;" id="filter_button" disabled>Filtrar</button>
            </div>
          </form>
        </div>
      </div>
      <hr>
      <!-- Tabla con las tarifas -->
      <div class="container">
        <div class="row">
          <div class="col-12">
            <table id="prices_table" class="table table-hover">
              <thead>
                <tr id="table_header">
                  <th scope="col">Código Categoría</th>
                  <th scope="col">Nombre Categoría</th>
                  <th scope="col">Sucursal</th>
                  <th scope="col">Tipo de Tarifa</th>
                  <th scope="col">Temporada</th>
                  <th scope="col">Medida de Tiempo</th>
                  <th scope="col">Unidades</th>
                  <th scope="col">Precio</th>
                  <th scope="col">KM Incluidos</th>
                  <th scope="col">Precio Extra KM</th>
                  <th scope="col">Depósito</th>
                  <th scope="col">Exceso</th>
                  <th scope="col">ID Definición Precio</th>
                  <th scope="col">ID Precio</th>
                </tr>
              </thead>
              <tbody id="table_body">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Acciones -->
      <div class="container">
        <div class="row">
          <div class="col-12">
            <button class="btn btn-secondary w-100">Importar</button>
          </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
      $(document).ready(function() {
        // Initialize select2
        $('#rental_location').select2({ theme: 'bootstrap-5' });
        $('#rate_type').select2({ theme: 'bootstrap-5' });
        $('#season_definition_id').select2({ theme: 'bootstrap-5' });
        $('#season_id').select2({ theme: 'bootstrap-5' });
        $('#season_duration').select2({ theme: 'bootstrap-5' });

        // Load initial data
        loadRentalLocations();

        // Event handlers
        $('#rental_location').on('change', function() {
          var val = $(this).val();
          if (val) {
            loadRateTypes(val);
            disableSubsequent('rental_location');
          } else {
            clearSelect('#rate_type');
            disableSubsequent('rental_location');
          }
          updateButton();
        });

        $('#rate_type').on('change', function() {
          var rentalLocationVal = $('#rental_location').val();
          var val = $(this).val();
          if (val && rentalLocationVal) {
            loadSeasonDefinitions(rentalLocationVal);
            disableSubsequent('rate_type');
          } else {
            clearSelect('#season_definition_id');
            disableSubsequent('rate_type');
          }
          updateButton();
        });

        $('#season_definition_id').on('change', function() {
          var val = $(this).val();
          if (val) {
            loadSeasons(val);
            disableSubsequent('season_definition_id');
          } else {
            clearSelect('#season_id');
            disableSubsequent('season_definition_id');
          }
          updateButton();
        });

        $('#season_id').on('change', function() {
          var val = $(this).val();
          if (val !== '') {
            loadDurations();
            $('#season_duration').prop('disabled', false).trigger('change.select2');
          } else {
            clearSelect('#season_duration');
            $('#season_duration').prop('disabled', true).trigger('change.select2');
          }
          updateButton();
        });

        $('#season_duration').on('change', function() {
          updateButton();
        });

        $('#filter_button').on('click', function(e) {
          e.preventDefault();
          loadPrices();
        });

        function loadRentalLocations() {
          $.get('/api/rental_locations', function(data) {
            populateSelect('#rental_location', data);
          });
        }

        function loadDurations() {
          $.get('/api/durations', function(data) {
            populateSelect('#season_duration', data);
            $('#season_duration').prop('disabled', false).trigger('change.select2');
          });
        }

        function loadRateTypes(rentalLocationId) {
          $.get('/api/rate_types', { rental_location_id: rentalLocationId }, function(data) {
            populateSelect('#rate_type', data);
            $('#rate_type').prop('disabled', false).trigger('change.select2');
          });
        }

        function loadSeasonDefinitions(rentalLocationId) {
          $.get('/api/season_definitions', { rental_location_id: rentalLocationId }, function(data) {
            populateSelect('#season_definition_id', data);
            $('#season_definition_id').prop('disabled', false).trigger('change.select2');
          });
        }

        function loadSeasons(seasonDefinitionId) {
          $.get('/api/seasons', { season_definition_id: seasonDefinitionId }, function(data) {
            populateSelect('#season_id', data, true); // true to include "Sin temporadas"
            $('#season_id').prop('disabled', false).trigger('change.select2');
          });
        }

        function loadPrices() {
          var params = {
            rental_location_id: $('#rental_location').val(),
            rate_type_id: $('#rate_type').val(),
            season_definition_id: $('#season_definition_id').val(),
            season_id: $('#season_id').val(),
            duration: $('#season_duration').val()
          };

          $.get('/api/prices', params, function(data) {
            updateTable(data);
          }).fail(function(jqXHR, textStatus, errorThrown) {
            alert('Error al cargar los precios: ' + textStatus);
          });
        }

        function populateSelect(selector, data, includeNoSeason = false) {
          var $select = $(selector);
          $select.empty();
          $select.append('<option value="">Seleccione...</option>');
          if (includeNoSeason) {
            $select.append('<option value="0">Sin temporadas</option>');
          }
          data.forEach(function(item) {
            $select.append('<option value="' + item.id + '">' + item.name + '</option>');
          });
        }

        function clearSelect(selector) {
          var $select = $(selector);
          $select.empty();
          $select.append('<option value="">Seleccione...</option>');
          $select.prop('disabled', true).trigger('change.select2');
        }

        function disableSubsequent(from) {
          if (from === 'rental_location') {
            clearSelect('#rate_type');
            clearSelect('#season_definition_id');
            clearSelect('#season_id');
            clearSelect('#season_duration');
          } else if (from === 'rate_type') {
            clearSelect('#season_definition_id');
            clearSelect('#season_id');
            clearSelect('#season_duration');
          } else if (from === 'season_definition_id') {
            clearSelect('#season_id');
            clearSelect('#season_duration');
          } else if (from === 'season_id') {
            clearSelect('#season_duration');
          }
        }

        function updateButton() {
          var disabled = $('#rental_location').val() === '' ||
                          $('#rate_type').val() === '' ||
                          $('#season_definition_id').val() === '' ||
                          $('#season_id').val() === '' ||
                          $('#season_duration').val() === '';
          $('#filter_button').prop('disabled', disabled);
        }

        function updateTable(data) {
          // Check if table elements exist
          var $header = $('#table_header');
          var $body = $('#table_body');

          if ($header.length === 0 || $body.length === 0) {
            return;
          }

          // Destroy existing DataTable (this resets it to original state)
          if ($.fn.DataTable.isDataTable('#prices_table')) {
            $('#prices_table').DataTable().destroy();
            // Remove the manual emptying here to avoid interference
          }

          // Explicitly empty the header and body before repopulating
          $header.empty();
          $body.empty();

          // Update header
          $header.append('<th scope="col">Código Categoría</th><th scope="col">Nombre Categoría</th><th scope="col">Sucursal</th><th scope="col">Tipo de Tarifa</th><th scope="col">Temporada</th><th scope="col">Medida de Tiempo</th><th scope="col">Unidades</th><th scope="col">Precio</th><th scope="col">KM Incluidos</th><th scope="col">Precio Extra KM</th><th scope="col">Depósito</th><th scope="col">Exceso</th><th scope="col">ID Definición Precio</th><th scope="col">ID Precio</th>');

          // Update body
          if (data.prices && data.prices.length > 0) {
            data.prices.forEach(function(price) {
              var row = '<tr>' +
                '<td>' + price.category_code + '</td>' +
                '<td>' + price.category_name + '</td>' +
                '<td>' + price.rental_location_name + '</td>' +
                '<td>' + price.rate_type_name + '</td>' +
                '<td>' + price.season_name + '</td>' +
                '<td>' + price.time_measurement + '</td>' +
                '<td>' + price.units + '</td>' +
                '<td class="text-right">' + price.price + '</td>' +
                '<td>' + price.included_km + '</td>' +
                '<td>' + price.extra_km_price + '</td>' +
                '<td>' + price.deposit + '</td>' +
                '<td>' + price.excess + '</td>' +
                '<td>' + price.price_definition_id + '</td>' +
                '<td>' + price.price_id + '</td>' +
                '</tr>';
              $body.append(row);
            });

            // Initialize DataTable AFTER content is added
            try {
              $('#prices_table').DataTable({
                paging: true,
                searching: false,
                info: true,
                destroy: true,
                autoWidth: false
              });
            } catch (error) {
              // Fallback to plain table if DataTable fails
              $('#prices_table').addClass('table table-striped');
            }
          } else {
            var colspan = 14;
            $body.append('<tr><td colspan="' + colspan + '" class="text-center">No hay datos disponibles</td></tr>');
          }
        }

        updateButton();
      });
    </script>
